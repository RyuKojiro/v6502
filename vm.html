<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>v6502: Virtual Machine</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">v6502
   </div>
   <div id="projectbrief">The MOS 6502 Virtual Machine and Toolchain Infrastructure</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">index</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Virtual Machine </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="referenceplatform"></a>
Interactive VM</h1>
<p>The included v6502 executable that is built using the v6502 API provides an interactive debugger to a v6502 instance that allows arbitrary manipulation of the machine and loading of data into memory. The interpreter will accept any valid 6502 assembly as instructions to execute in-place without stepping the CPU. The prompt always displays the current program counter address in hex, when halted. When running the CPU can be interrupted with a SIGINT or ^C. Binary images can be specified as arguments prior to runtime and automatically run on start.</p>
<p>The non-assembly commands are as follows:</p>
<pre class="fragment">cpu                 Displays the current state of the CPU.
disassemble &lt;addr&gt;  Disassemble 10 instructions starting at a given address, or the program counter if no address is specified.
help                Displays this help.
load &lt;file&gt;         Load binary image into memory at 0x0600.
peek &lt;addr&gt;         Dumps the memory at and around a given address.
quit                Exits v6502.
run                 Contunuously steps the cpu until a 'brk' instruction is encountered.
reset               Resets the CPU.
mreset              Zeroes all memory.
step                Forcibly steps the CPU once.
verbose             Toggle verbose mode; prints each instruction as they are executed when running.
</pre><p>The command interpreter supports shortening of these commands as far as possible without being ambiguous. Ambiguous commands have an arbitrary priority based on usefulness.</p>
<p>Example usage (debugging a binary):</p>
<pre class="fragment">Creating 1 virtual CPU…
Allocating 64k of virtual memory…
Resetting CPU…
Loading binary image "overflow.o" into memory…
Loaded 137 bytes.
Running…
Encountered 'brk' at 0x03.
(0x0004) disass $0600
0x0600: d8       - cld 
0x0601: a9 01    - lda #$01
0x0603: 8d 00 00 - sta $0000
0x0606: a9 80    - lda #$80
0x0608: 8d 00 00 - sta $0000
0x060b: 8d 00 00 - sta $0000
0x060e: a9 00    - lda #$00
0x0610: 8d 00 00 - sta $0000
0x0613: 8d 00 00 - sta $0000
0x0616: a0 01    - ldy #$01
(0x0004) v
Verbose mode enabled.
(0x0004) reset
(0x0600) r
0x0600: d8       - cld 
0x0601: a9 01    - lda #$01
0x0603: 8d 00 00 - sta $0000
0x0606: a9 80    - lda #$80
    … 20 lines ommitted …
0x061d: f0 1f    - beq $1f
0x063e: 60       - rts 
0x0003: 00       - brk 
Encountered 'brk' at 0x03.
(0x0004) cpu
Status Register: --XB-IZ-
CPU 0x100103a90: pc = 0x0004, ac = 0x00, x = 0x01, y = 0x01, sr = 0x36, sp = 0x01
MEM 0x100103ab0: memsize = 65535 (0xffff)
(0x0004) 
</pre><h1><a class="anchor" id="api"></a>
API</h1>
<p>The simplest fault tolerant implementation of a v6502 instance, using the v6502 API, is as follows:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cpu_8h.html">v6502/cpu.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mem_8h.html">v6502/mem.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> fault(<span class="keywordtype">void</span> *ctx, <span class="keyword">const</span> <span class="keywordtype">char</span> *e) {</div><div class="line">    (*(<span class="keywordtype">int</span> *)ctx)++;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span> * argv[])</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> faulted = 0;</div><div class="line">    </div><div class="line">    <a class="code" href="structv6502__cpu.html">v6502_cpu</a> *cpu = <a class="code" href="group__cpu__lifecycle.html#ga88ef3cc2d86ad7dfb07703f27dd1bf24">v6502_createCPU</a>();</div><div class="line">    cpu-&gt;<a class="code" href="structv6502__cpu.html#ac7ee3d5c327f1b020ce145c6293c14e2">memory</a> = <a class="code" href="group__mem__lifecycle.html#ga6be2947e83760b851d9d3b3991190e3b">v6502_createMemory</a>(2048);</div><div class="line">    cpu-&gt;<a class="code" href="structv6502__cpu.html#ab596b5af1d22c10ef9ea2e235571697d">fault_callback</a> = fault;</div><div class="line">    cpu-&gt;<a class="code" href="structv6502__cpu.html#af1f2bd7c53c22492621a07c3426a3852">fault_context</a> = &amp;faulted;</div><div class="line"></div><div class="line">    <a class="code" href="group__cpu__exec.html#gab2eee033ba4d5676191b247873e153e4">v6502_reset</a>(cpu);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (!faulted) {</div><div class="line">        <a class="code" href="group__cpu__exec.html#gadad0d0261ef9cf86e6ecfe44f28de986">v6502_step</a>(cpu);</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group__mem__lifecycle.html#gac6fa0ce648a216dc8f653545ebca1d5b">v6502_destroyMemory</a>(cpu-&gt;<a class="code" href="structv6502__cpu.html#ac7ee3d5c327f1b020ce145c6293c14e2">memory</a>);</div><div class="line">    <a class="code" href="group__cpu__lifecycle.html#gad67d77d6eef35f2abbb43e1322c6979f">v6502_destroyCPU</a>(cpu);</div><div class="line">}</div></div><!-- fragment --><p>It is worth noting that this code will run the cpu at the fastest possible speed, with no regulation of timing. This is important for applications that expect a working CPU clock. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Feb 6 2019 00:29:39 for v6502 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
